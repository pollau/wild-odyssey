---
const locale = Astro.currentLocale || 'fr';

const content = {
    fr: {
        title: "Testez votre connaissance de l'Océan",
        subtitle: "Répondez aux questions en descendant dans les profondeurs",
        result_title: "Votre score d'explorateur : ",
        low_score: {
            msg: "Pas d'inquiétude, l'Océan est un sujet vaste et complexe. Nous sommes là pour vous aider à comprendre ces enjeux et l'impact positif que vous pouvez avoir à votre échelle.",
            cta: "Découvrez nos ateliers pour agir.",
        },
        high_score: {
            msg: "Bravo ! Vous avez déjà une belle conscience écologique. Nous pouvons vous aider à aller encore plus loin et à engager concrètement vos équipes.",
            cta: "Amplifiez votre impact dès maintenant.",
        },
        btn_label: "Agir à notre échelle",
        depths: [
            { 
                level: 0, 
                label: "Surface",
                question: "Quelle part de la chaleur excédentaire mondiale l'Océan absorbe-t-il ?",
                options: ["10%", "50%", "+90%"],
                correct: 2,
                title: "Le Régulateur Thermique",
                desc: "L'Océan est notre bouclier climatique. Il a absorbé plus de 90% de la chaleur générée par nos activités, retardant le réchauffement de l'atmosphère."
            },
            { 
                level: 100, 
                label: "-100m",
                question: "D'où vient 50% de l'oxygène que vous respirez ?",
                options: ["Des forêts", "Du phytoplancton", "Des marais"],
                correct: 1,
                title: "Le Deuxième Poumon",
                desc: "Merci le phytoplancton et les cyanobactéries ! Sans cette vie microscopique marine, l'air serait irrespirable sur Terre."
            },
            { 
                level: 500, 
                label: "-500m",
                question: "Combien de temps un plastique met-il à disparaître en mer ?",
                options: ["10 ans", "100 ans", "Jamais (il se fragmente)"],
                correct: 2,
                title: "L'Illusion de la Disparition",
                desc: "Le plastique ne disparaît pas, il se transforme en microplastiques. Ingérés par les poissons, ils remontent la chaîne alimentaire... jusqu'à nous."
            },
            { 
                level: 1000, 
                label: "-1000m",
                question: "Lequel stocke le plus de carbone ?",
                options: ["L'atmosphère", "Les forêts", "L'Océan"],
                correct: 2,
                title: "La Bombe Carbone",
                desc: "L'Océan est le principal puits de carbone. Les abysses stockent des quantités colossales de CO2. Perturber cet équilibre serait catastrophique."
            }
        ]
    },
    en: {
        title: "Test your Ocean Knowledge",
        subtitle: "Answer questions as you dive deeper",
        result_title: "Your Explorer Score: ",
        low_score: {
            msg: "No worries, the Ocean is vast and complex. We are here to help you understand these challenges and the positive impact you can have at your scale.",
            cta: "Discover our workshops to take action.",
        },
        high_score: {
            msg: "Well done! You already have strong ecological awareness. We can help you go even further and concretely engage your teams.",
            cta: "Amplify your impact now.",
        },
        btn_label: "Act at our scale",
        depths: [
            { 
                level: 0, 
                label: "Surface",
                question: "How much of the world's excess heat does the Ocean absorb?",
                options: ["10%", "50%", "+90%"],
                correct: 2,
                title: "The Thermal Regulator",
                desc: "The Ocean is our climate shield. It has absorbed over 90% of the heat generated by human activity, delaying atmospheric warming."
            },
            { 
                level: 100, 
                label: "-100m",
                question: "Where does 50% of the oxygen you breathe come from?",
                options: ["Forests", "Phytoplankton", "Swamps"],
                correct: 1,
                title: "The Second Lung",
                desc: "Thanks to phytoplankton and cyanobacteria! Without this microscopic marine life, Earth's air would be unbreathable."
            },
            { 
                level: 500, 
                label: "-500m",
                question: "How long does plastic take to disappear in the ocean?",
                options: ["10 years", "100 years", "Never (it fragments)"],
                correct: 2,
                title: "The Illusion of Disappearance",
                desc: "Plastic doesn't disappear; it breaks down into microplastics. Eaten by fish, they move up the food chain... right back to us."
            },
            { 
                level: 1000, 
                label: "-1000m",
                question: "Which stores the most carbon?",
                options: ["The Atmosphere", "Forests", "The Ocean"],
                correct: 2,
                title: "The Carbon Bomb",
                desc: "The Ocean is the primary carbon sink. The abyss stores colossal amounts of CO2. Disturbing this balance would be catastrophic."
            }
        ]
    },
    es: {
        title: "Pon a prueba tu conocimiento del Océano",
        subtitle: "Responde preguntas mientras desciendes a las profundidades",
        result_title: "Tu Puntuación de Explorador: ",
        low_score: {
            msg: "No te preocupes, el Océano es un tema vasto y complejo. Estamos aquí para ayudarte a comprender estos desafíos y el impacto positivo que puedes tener a tu escala.",
            cta: "Descubre nuestros talleres para actuar.",
        },
        high_score: {
            msg: "¡Bravo! Ya tienes una buena conciencia ecológica. Podemos ayudarte a ir aún más lejos e involucrar concretamente a tus equipos.",
            cta: "Amplifica tu impacto ahora.",
        },
        btn_label: "Actuar a nuestra escala",
        depths: [
            { 
                level: 0, 
                label: "Superficie",
                question: "¿Qué parte del calor excedente mundial absorbe el Océano?",
                options: ["10%", "50%", "+90%"],
                correct: 2,
                title: "El Regulador Térmico",
                desc: "El Océano es nuestro escudo climático. Ha absorbido más del 90% del calor generado por nuestras actividades, retrasando el calentamiento atmosférico."
            },
            { 
                level: 100, 
                label: "-100m",
                question: "¿De dónde viene el 50% del oxígeno que respiras?",
                options: ["De los bosques", "Del fitoplancton", "De los pantanos"],
                correct: 1,
                title: "El Segundo Pulmón",
                desc: "¡Gracias al fitoplancton y las cianobacterias! Sin esta vida microscópica marina, el aire sería irrespirable en la Tierra."
            },
            { 
                level: 500, 
                label: "-500m",
                question: "¿Cuánto tarda el plástico en desaparecer en el mar?",
                options: ["10 años", "100 años", "Nunca (se fragmenta)"],
                correct: 2,
                title: "La Ilusión de la Desaparición",
                desc: "El plástico no desaparece, se transforma en microplásticos. Ingeridos por los peces, suben por la cadena alimentaria... hasta nosotros."
            },
            { 
                level: 1000, 
                label: "-1000m",
                question: "¿Cuál almacena más carbono?",
                options: ["La atmósfera", "Los bosques", "El Océano"],
                correct: 2,
                title: "La Bomba de Carbono",
                desc: "El Océano es el principal sumidero de carbono. Los abismos almacenan cantidades colosales de CO2. Perturbar este equilibrio sería catastrófico."
            }
        ]
    },
};

const t = content[locale];
const depths = t.depths;
---

<section id="deep-dive" class="relative w-full overflow-hidden text-white pt-10 pb-0">
    
    <!-- Gradient Background -->
    <div class="absolute inset-0 z-0 bg-gradient-to-b from-[#0B3D91] via-[#006994] to-[#000d1a]"></div>
    
    <div class="relative z-10 max-w-5xl mx-auto px-6 py-24 pb-48 flex flex-col items-center">
        
        <div class="text-center mb-24 max-w-3xl">
            <h2 class="font-heading text-4xl md:text-5xl font-bold mb-6 leading-tight">{t.title}</h2>
            <p class="text-xl md:text-2xl text-blue-100 font-medium">{t.subtitle}</p>
            <div class="mt-12 animate-bounce">
                <svg class="w-10 h-10 text-white/50 mx-auto" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 14l-7 7-7-7m14-8l-7 7-7-7" />
                </svg>
            </div>
        </div>

        <!-- Quiz Container -->
        <div class="relative w-full max-w-4xl">
            <div class="absolute left-4 md:left-1/2 top-0 bottom-0 w-1 bg-white/20 rounded-full"></div>

            <div class="space-y-40">
                {depths.map((depth, index) => (
                    <div class={`relative flex items-center ${index % 2 === 0 ? 'md:flex-row-reverse' : ''} group quiz-step`} data-correct={depth.correct}>
                        <!-- Dot -->
                        <div class="depth-dot absolute left-4 md:left-1/2 -ml-[9px] w-6 h-6 bg-secondary rounded-full border-4 border-[#0B3D91] shadow-[0_0_20px_rgba(0,139,139,0.8)] z-20 transition-all duration-300"></div>

                        <!-- Content Side -->
                        <div class="w-full md:w-1/2 pl-16 md:pl-0 md:px-12">
                            <div class="quiz-card bg-white/5 backdrop-blur-sm p-8 rounded-2xl border border-white/10 hover:bg-white/10 transition-colors shadow-lg">
                                <div class="flex items-center gap-3 mb-4">
                                     <span class="inline-block px-3 py-1 rounded-full bg-secondary/80 text-white text-xs font-bold uppercase tracking-widest shadow-sm">
                                        {depth.label}
                                    </span>
                                </div>
                               
                                <!-- Question State -->
                                <div class="quiz-question">
                                    <h3 class="text-xl font-bold mb-6 text-white leading-snug">{depth.question}</h3>
                                    <div class="flex flex-col gap-3">
                                        {depth.options.map((opt, optIndex) => (
                                            <button 
                                                class="quiz-option text-left px-4 py-3 rounded-lg bg-white/10 hover:bg-white/20 border border-white/10 transition-all text-sm md:text-base font-medium"
                                                data-index={optIndex}
                                            >
                                                {opt}
                                            </button>
                                        ))}
                                    </div>
                                </div>

                                <!-- Result/Fact State (Hidden initially) -->
                                <div class="quiz-result hidden" data-title={depth.title}>
                                    <div class="mb-4">
                                        <span class="result-badge inline-block px-3 py-1 rounded-md text-sm font-bold mb-2"></span>
                                        <h3 class="text-2xl font-bold text-white">{depth.title}</h3>
                                    </div>
                                    <p class="text-blue-100 text-lg leading-relaxed">
                                        {depth.desc}
                                    </p>
                                </div>

                            </div>
                        </div>

                        <!-- Spacer Side -->
                        <div class="hidden md:block w-1/2"></div>
                    </div>
                ))}
            </div>
        </div>

        <!-- Final Score CTA -->
        <div id="quiz-final" class="hidden text-center mt-40 max-w-2xl mx-auto bg-gradient-to-br from-white/10 to-transparent p-10 rounded-3xl border border-white/20 backdrop-blur-md transition-all duration-500 transform scale-95 opacity-0">
            <h3 class="text-3xl md:text-4xl font-bold text-white mb-6 leading-tight">
                {t.result_title} <span id="final-score" class="text-secondary text-5xl">0/4</span>
            </h3>
            
            <p id="score-msg" class="text-blue-100 text-lg mb-4 italic"></p>
            <p id="score-cta" class="text-white text-xl font-bold mb-10"></p>

            <a href="#contact" class="inline-flex items-center gap-2 bg-accent hover:bg-orange-600 text-white font-bold py-4 px-8 rounded-full shadow-[0_4px_20px_rgba(255,107,53,0.4)] transform hover:scale-105 transition-all text-lg">
                <span>{t.btn_label}</span>
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 8l4 4m0 0l-4 4m4-4H3"></path></svg>
            </a>
        </div>
    </div>
</section>

<!-- Pass localized strings to Script -->
<script define:vars={{ lowScore: t.low_score, highScore: t.high_score }}>
    // Quiz Interactive Logic
    let score = 0;
    let questionsAnswered = 0;
    const totalQuestions = 4;

    const steps = document.querySelectorAll('.quiz-step');
    const finalSection = document.getElementById('quiz-final');
    // ... (existing logic)

    // --- SMART SCROLL LOGIC ---
    // 1. Hero -> Deep Dive Transition
    let isScrolling = false;
    const heroSection = document.querySelector('section:first-of-type'); // Assuming Hero is first
    const deepDiveSection = document.getElementById('deep-dive');

    // Simple observer to know if we are in Hero
    const heroObserver = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
            if (entry.isIntersecting) {
                document.addEventListener('wheel', handleHeroScroll, { passive: false });
            } else {
                document.removeEventListener('wheel', handleHeroScroll);
            }
        });
    }, { threshold: 0.5 });

    if (heroSection) heroObserver.observe(heroSection);

    function handleHeroScroll(e) {
        // If scrolling down frankly
        if (e.deltaY > 30 && !isScrolling) {
            e.preventDefault();
            isScrolling = true;
            deepDiveSection.scrollIntoView({ behavior: 'smooth' });
            setTimeout(() => { isScrolling = false; }, 1000);
        }
    }

    // 2. Quiz "Stop at Unanswered" Logic
    // We want to snap to the first unanswered question if scrolling down
    // This requires a more complex "wheel" handler on the deep dive section
    
    // For now, let's keep it simple to avoid locking the user:
    // When answering a question -> Smooth scroll to next question (Already mostly handled by UI transition?)
    // Let's add that explicitly.

    steps.forEach((step, index) => {
        const nextStep = steps[index + 1]; // Next question
        
        // ... existing vars ...
        const correctIndex = parseInt(step.dataset.correct);
        const options = step.querySelectorAll('.quiz-option');
        const questionBox = step.querySelector('.quiz-question');
        const resultBox = step.querySelector('.quiz-result');
        const dot = step.querySelector('.depth-dot');
        const badge = resultBox.querySelector('.result-badge');

        options.forEach(opt => {
            opt.addEventListener('click', () => {
                if (step.classList.contains('answered')) return;
                step.classList.add('answered');

                const chosenIndex = parseInt(opt.dataset.index);
                const isCorrect = chosenIndex === correctIndex;

                // Visual Feedback
                if (isCorrect) {
                    score++;
                    opt.classList.add('bg-green-500', 'border-green-400', 'text-white');
                    dot.classList.remove('bg-secondary');
                    dot.classList.add('bg-green-500', 'shadow-[0_0_20px_rgba(34,197,94,0.8)]');
                    badge.classList.add('bg-green-500/20', 'text-green-300');
                    badge.textContent = "Correct !";
                } else {
                    opt.classList.add('bg-red-500', 'border-red-400', 'text-white');
                    options[correctIndex].classList.add('bg-green-500/50', 'border-green-400/50');
                    dot.classList.remove('bg-secondary');
                    dot.classList.add('bg-red-500', 'shadow-[0_0_20px_rgba(239,68,68,0.8)]');
                    badge.classList.add('bg-red-500/20', 'text-red-300');
                    badge.textContent = "Oups...";
                }

                // Transition UI
                setTimeout(() => {
                    questionBox.classList.add('hidden');
                    resultBox.classList.remove('hidden');
                    questionsAnswered++;
                    checkCompletion();
                    
                    // AUTO SCROLL TO NEXT QUESTION
                    if (nextStep) {
                        nextStep.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    } else {
                         // Scroll to result if last
                         if (questionsAnswered === totalQuestions) {
                             setTimeout(() => finalSection.scrollIntoView({ behavior: 'smooth', block: 'center' }), 500);
                         }
                    }

                }, 800); // Increased delay for reading
            });
        });
    });

    // ... existing checkCompletion ...
    function checkCompletion() {
        if (questionsAnswered === totalQuestions) {
            finalSection.classList.remove('hidden');
            setTimeout(() => {
                finalSection.classList.remove('scale-95', 'opacity-0');
                finalSection.classList.add('scale-100', 'opacity-100');
                
                document.getElementById('final-score').textContent = `${score}/${totalQuestions}`;
                const isGood = score >= 3;
                const content = isGood ? highScore : lowScore;
                document.getElementById('score-msg').textContent = `"${content.msg}"`;
                document.getElementById('score-cta').textContent = content.cta;
            }, 100);
        }
    }
</script>
